(()=>{"use strict";function e(e=Date.now()){return Math.floor(e/1e3)}function n(e,n){return Object.prototype.toString.call(e)===`[object ${n}]`}function t(e){return n(e,"String")}function r(e,n){return Promise.all(e.tables.map((({table:t})=>"apps"!==t?e.list({field:"changed",keyRange:[n.remoteSyncAt>0?n.remoteSyncAt:"ge",n.syncAt]},{start:0,limit:0},t).then((e=>Promise.resolve(Array.isArray(e.data)&&e.data.length>0?{[t]:e.data}:null))):Promise.resolve(null))))}function s(e,n){if(!e)return;let t=0;if(e.forEach){const r=e.length;if(r<=0)return;for(;t<r&&!n(e[t],t);)t++}else{const r=Object.keys(e),s=r.length;if(s<=0)return;for(;t<s&&!n(e[r[t]],r[t]);)t++}}function i(t,i){return r(t,i).then((r=>{const o=(r||[]).filter((e=>!!e)),c=i.remoteUpdate?i.remoteSyncAt:null;return t.fetch(`storage/sync?changed=${i.syncAt}`,{silence:i.silence}).then((e=>{const r=e||{};if(!n(r,"Object")||Object.keys(r).length<=0)return Promise.resolve([]);const i={};s(o,(e=>{s(e,((e,n)=>{Array.isArray(e)&&e.forEach((e=>{if(!r[n]||!Array.isArray(r[n]))return;const t=r[n].find((n=>n.id===e.id));t||(!Array.isArray(i[n])&&(i[n]=[]),!i[n].includes(e.id)&&i[n].push(e.id))}))}))}));const c=Object.keys(i);return c.length>0?Promise.all(c.map((e=>t.remove(i[e],e)))).then((()=>Promise.resolve(r))):Promise.resolve(r)})).then((e=>e.length<=0?Promise.reject("empty_cloud"):t.import(e))).then((()=>t.set("sync_at",c||e(),"apps")))}))}function o(n,t){return r(n,t).then((r=>{const i=(r||[]).filter((e=>!!e));if(i.length<=0)return Promise.resolve([]);const o={};return s(i,(e=>{s(e,((e,n)=>{!Array.isArray(o[n])&&(o[n]=[]),Array.isArray(e)&&e.forEach((e=>{o[n].push(e)}))}))})),n.fetch("storage/sync",{silence:t.silence,data:{data:o,version:n.version}}).then((()=>n.set("sync_at",e(),"apps")))}))}function c(n,r){return Promise.all([n.get("sync_at","apps"),n.fetch("storage/sync",{silence:!!r})]).then((([e,n])=>{const r=n&&n.changed?n.changed:0;return Promise.resolve({syncAt:e||0,remoteSyncAt:t(r)?parseInt(r):r})})).then((({syncAt:t,remoteSyncAt:c})=>{const a=1661952271;return c<=0?o(n,{syncAt:a,remoteSyncAt:c,silence:!!r}):t<=0?i(n,{syncAt:a,silence:!!r,remoteSyncAt:e()}):function(e){const n=[];return s(e.tables,(({table:t})=>{"apps"!==t&&n.push(e.list({field:"changed"},{start:1,limit:1},t).then((e=>Array.isArray(e.data)&&e.data.length>0?e.data[0]:null)))})),Promise.all(n).then((e=>{const n=e.filter((e=>!!e));if(Array.isArray(n)&&n.length>0){const e=n.sort(((e,n)=>e.changed>n.changed?1:-1)).pop();return Promise.resolve(e.changed?e.changed:0)}return Promise.resolve()}))}(n).then((e=>{const s=e||t;return s===c?Promise.reject("unnecessary"):s>c?c-t>10?i(n,{syncAt:t,remoteSyncAt:c,remoteUpdate:!0,silence:!!r}):o(n,{silence:!!r,syncAt:s,remoteSyncAt:t}):i(n,{silence:!!r,syncAt:c,remoteSyncAt:t>s?s:t})}))}))}window.definePlugin("sync",(function(t){return{onSync_Auto(e){e.user.is_logged_in&&e.user.roles.includes("premium")&&e.get("sync_auto").then((t=>{t&&(e.data("running")||e.get("sync_at","apps").then((t=>{(n(t,"Number")?t:0)+120>Date.now()/1e3||(e.data("running",!0),c(e,!0).then((()=>{})).catch((n=>{e.log(n)})).finally((()=>{e.data("running",!1)})))})))}))},onSync_Pull(e){e.user.is_logged_in?e.user.roles.includes("member")||e.user.roles.includes("premium")?this.onSelf(e,"pull"):e.fire("subscribe"):e.fire("account","login",(function(){e.fire("account")}))},onSync_Push(e){e.user.is_logged_in?e.user.roles.includes("member")||e.user.roles.includes("premium")?this.onSelf(e,"push"):e.fire("subscribe"):e.fire("account","login",(function(){e.fire("account")}))},onSelf(n,r){n.user.is_logged_in?n.data("running")?n.error("busy"):n.fire("notice",{duration:0,type:"warning",message:n.i18n(`${r||"sync"}_confirm`)},(()=>{let s;s="pull"===r?function(n){return n.fetch("storage/pull").then(n.import).then((()=>n.set("sync_at",e(),"apps")))}(n):"push"===r?function(n){return n.export().then((t=>n.fetch("storage/push",{data:t}).then((()=>n.set("sync_at",e(),"apps")))))}(n):c(n),n.data("running",!0),n.fire(`${t.id}_status`,!0),n.fire("toolbar_state",t.id,"loading"),s.then((()=>{n.success(`${r||"sync"}_done`)})).catch((e=>{n.error(e&&e.message?e.message:e)})).finally((()=>{n.data("running",!1),n.fire(`${t.id}_status`,!1),n.fire("toolbar_state",t.id,"loaded")}))})):n.fire("account","login",(function(){n.fire("account")}))}}}))})();