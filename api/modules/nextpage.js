(()=>{"use strict";function t(t,e){return Object.prototype.toString.call(t)===`[object ${e}]`}function e(e){return t(e,"String")}function n(t){return t&&t.nodeType&&1===t.nodeType}function r(t=location.href){if(/circle=/.test(t)){const[e,n=""]=t.split("#");if(!n)return t;const{hashs:r}=function(t,e,n=location.hash.substring(1).split("&")){let r=[];if(n.join("").length<=0)return{hashs:[],hash:r};const i=Array.isArray(t)?t:[t],o=n.filter((t=>{if(i.findIndex((e=>t.indexOf(e)>=0))<0)return!0;r.push(t)}));if(e){const n=`${t}=${e}`;o.push(n),r=[],r.push(n)}return{hashs:o,hash:r}}(["circle","widget"],void 0,n.split("&"));return`${e}${r.length>0?"#"+r.join("&"):""}`}return t}function i(t=location.href){if(/circle=/.test(t)){const[e,n=""]=t.split("#");if(!n)return t;const{hashs:r}=function(t,e,n=location.hash.substring(1).split("&")){let r=[];if(n.join("").length<=0)return{hashs:[],hash:r};const i=Array.isArray(t)?t:[t],o=n.filter((t=>{if(i.findIndex((e=>t.indexOf(e)>=0))<0)return!0;r.push(t)}));if(e){const n=`${t}=${e}`;o.push(n),r=[],r.push(n)}return{hashs:o,hash:r}}(["circle","widget"],void 0,n.split("&"));return`${e}${r.length>0?"#"+r.join("&"):""}`}return t}function o(t){const e=t.href,n=i();if(e&&e!==n&&!e.startsWith("javascript"))return e;let r="";if(function(t,e){if(!t)return;let n=0;if(t.forEach){const r=t.length;if(r<=0)return;for(;n<r&&!e(t[n],n);)n++}else{const r=Object.keys(t),i=r.length;if(i<=0)return;for(;n<i&&!e(t[r[n]],r[n]);)n++}}(t.attributes,(t=>{const e=`${t.nodeValue}`;if(e.split("/").length>1)return r=e.replace(/.*('|")(.*?)('|").*/,"$2"),!0})),r&&r.startsWith("/"))return r;return t.getAttribute("onclick")||""?t:""}function s(t,e){return Object.prototype.toString.call(t)===`[object ${e}]`}function u(t){return s(t,"String")}function c(t,e){return!(!t||!t.tagName)&&t.tagName.toLowerCase()===e}function l(t){return t&&t.nodeType&&1===t.nodeType}function f(t,e){if(t)return e&&u(e)?t.getAttribute(e):Array.prototype.slice.call(t.attributes).reduce(((t,e)=>`${t} ${e.nodeValue}`),"")}function a(t){if(!t)return"";let e="";u(t)?e=t:!function(t){return s(t,"Text")}(t)?l(t)&&(e=t.textContent):e=t.nodeValue;const n=(e||"").trim();return n.length>0?n.replace(/^&nbsp;+|&nbsp;+$/g,""):""}const h=/下一[页頁条章篇张張]|next|next\s*page|次のページ/i;function d(t,e){let n;if(e){const r=function(t,e,n,r){if(!e)return n?[]:void 0;let i;try{i=t.querySelectorAll(e)}catch{}if(!i)return n?[]:void 0;if(n)return i.length>0?[...i]:[];if(r){const t=[];return i.forEach((e=>{if(c(e,"a")){const n=e.href;if(n.startsWith("javascript")){const n=a(e);n.length>0&&t.push(n)}else n.length>0&&t.push(n)}else{const n=a(e);n.length>0&&t.push(n)}})),t.join(" ")}return a(i[0])}(t,e);if(r&&c(r,"a")){const t=o(r);t&&(n=t)}}if(n)return n;const r=location.href,i=location.host;let s=null;if(function(t,e){const n=Object.keys(t),r=n.length;if(r<=0)return;let i=r-1;for(;i>=0&&!e(t[n[i]],n[i]);)i--}(t.getElementsByTagName("a"),(t=>{const e=t.parentElement;if(t.host&&t.host!==i||!e)return;const n=t.href,o=a(t);if(n){if(h.test(`${f(t)} ${o}`)&&n!==r&&!n.startsWith("javascript"))return s=t,!0;if(1===e.childElementCount&&h.test(f(e)))return s=t,!0}else if(/下一[页頁章篇张張]/.test(o)||/next|next\s*page|次のページ/i.test(f(t)))return s=t,!0})),s&&l(s)){return o(s)}}window.definePlugin("nextpage",(function(t,i){let o,s,u,c=0,l=document,f="wait";const a=(t=0)=>window.scrollY+window.innerHeight+t>=document.documentElement.scrollHeight,h=()=>{o?i.set("auto_run",!0,"apps").then((()=>{o.click()})):(f="wait",i.fire("render_refetch"),setTimeout((()=>{i.fire("scrollpage_again");const t=i.field("container");if(!n(t))return;const e=Array.from(t.querySelectorAll(".page")).pop();n(e)&&i.fire("speak_again",e)}),1e3))},p=(t,r)=>{const s=(t=>{const e=i.applyFilter("rule",{})||{};return d(t,e&&e.next?e.next:"")})(t);if(n(s))return f="done",void(o=s);!e(s)||s.length<=0||(f="running",i.fire("node_from_context_by_url",s,((t,e,n)=>{if(!n)return f="wait",void(u&&u());if(l=n,u&&u(),t)r(t);else{const t=i.field("node")||[];t.push(e),i.field("node",t),r()}})))};return{enable(t){t.warning("refresh")},start(){function t(){if("wait"!==f&&a(360))return"running"===f?(u&&u(),void(u=i.loading())):void h()}window.addEventListener("scroll",t),this.destory(),s=()=>{window.removeEventListener("scroll",t)},i.get("auto_run","apps").then((t=>{t&&i.remove("auto_run","apps").then((()=>{i.fire("action_clicked")}))}))},destory(){s&&s()},onRenderPage(){!i.field("running")||c>1||p(l.body,(t=>{if(t)return f="wait",c++,void this.onRenderPage();c=0,a()?h():f="done"}))},onRenderLeave(t){const e=t.field("node");if(!Array.isArray(e))return;const n=e.pop();n&&n.url!==r()&&setTimeout((function(){const t=location.hash;location.href=`${n.url}${t?"/":"#"}circle=off`}),1e3)}}}))})();