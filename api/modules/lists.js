(()=>{"use strict";function t(t,e){return Object.prototype.toString.call(t)===`[object ${e}]`}function e(t=location.href){if(/circle=/.test(t)){const[e,i=""]=t.split("#");if(!i)return t;const{hashs:s}=function(t,e,i=location.hash.substring(1).split("&")){let s=[];if(i.join("").length<=0)return{hashs:[],hash:s};const n=Array.isArray(t)?t:[t],h=i.filter((t=>{if(n.findIndex((e=>t.indexOf(e)>=0))<0)return!0;s.push(t)}));if(e){const i=`${t}=${e}`;h.push(i),s=[],s.push(i)}return{hashs:h,hash:s}}(["circle","widget"],void 0,i.split("&"));return`${e}${s.length>0?"#"+s.join("&"):""}`}return t}window.definePlugin("lists",class{white;black;blackKey;whiteKey;blacksite;constructor(){this.blackKey="",this.whiteKey="",this.white="whitelist",this.black="blacklist",this.blacksite=!1}isSite(t){return!!t.id&&t.id===location.hostname}siteTitle(){return(document.title||"").trim().replace(/[^|\-\\/>»]*[|\-\\/>»](.*)/gi,"$1")}listsAdd(e,i){const s=i.id,n=i.deny,h=this.isSite(i);e.get(s,"node").then((r=>{if(r&&r.deny===n)e.remove(s,"node").then((()=>{e.success("remove_success"),n?e.action("ready"):setTimeout((()=>{e.fire("toolbar_state",`${n?this.black:this.white}${h?"_site":""}`,"inactive")}),0),this.start(e)}));else{if(t(i.host,"Undefined")){const t=function(t){let e;try{e=new URL(/.*?:\/\//.test(t)?t:`http://${t}`)}catch(i){e={hash:"",href:t,host:"--",hostname:"--"}}return e}(i.id);i.host=t.hostname}e.set(s,i,"node").then((()=>{if(n)e.field("running")?e.fire("render",!1):e.success("add_success"),e.action("force");else{const t=e.field("node");t&&t.length>0&&!e.field("running")?e.fire("render",!0):e.success("add_success")}setTimeout((()=>{e.fire("toolbar_state",`${n?this.black:this.white}${h?"_site":""}`,"active")}),0),this.start(e)}))}}))}onWhitelist(t){this.listsAdd(t,{id:e(),deny:!1,title:this.siteTitle()})}onWhitelistSite(t){this.listsAdd(t,{deny:!1,title:this.siteTitle(),id:location.hostname})}onBlacklist(t){this.listsAdd(t,{id:e(),deny:!0,title:this.siteTitle()})}onBlacklistSite(t){this.listsAdd(t,{deny:!0,title:this.siteTitle(),id:location.hostname})}filterParseHold(t,e){return this.blackKey?(t.fire("loading",!1),!0):e}filterParseSuccessHold(t,e){return!this.whiteKey&&e}filterActionClickedAbort(t){if(this.blackKey){const e="remove_blacklist";return t.fire("notice",{key:e,duration:0,btnText:t.i18n("remove"),message:t.i18n("remove_blacklist"+(this.blacksite?"_site":""))},(()=>{t.remove(this.blackKey,"node").then((()=>{this.blackKey="",this.blacksite=!1,setTimeout((()=>{location.reload()}),1e3)})).catch((e=>{t.error(e)}))})),!0}}onListsChange(t){this.start(t)}onRenderEnter(t){t.fire("loading",!1)}start(e){const i=location.hostname;return e.list({searchIn:"host",search:i},{start:1,limit:30},"node").then((s=>{const n=e.match(s.data,i),h=e.match(s.data);if(!n&&!h)return[this.black,this.white,`${this.black}_site`,`${this.white}_site`].forEach((t=>{e.contextMenus("update",{id:t,label:e.i18n(`add_${t}`)})})),Promise.resolve(!0);const r={id:"",title:""},o=n||r,l=h||r,a=o.id||l.id,c=t(o.deny,"Boolean")?o.deny:!!l.deny;return c?(this.blackKey=a,this.blacksite=this.isSite(o)||this.isSite(o),e.field("running")&&e.fire("render",!1),e.action("force")):(this.whiteKey=a,setTimeout((()=>{e.fire("toolbar_state",`${this.white}${n?"_site":""}`,"active")}),1e3)),e.contextMenus("update",{id:`${c?this.black:this.white}${n?"_site":""}`,label:e.i18n(`${a?"remove":"add"}_${c?this.black:this.white}${n?"_site":""}`)})}))}})})();