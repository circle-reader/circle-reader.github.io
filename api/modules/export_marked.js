(()=>{"use strict";function t(t){let e=t,n=t.cloneNode(!0);for(;e;){const r=e._mirrorElement;n._mirrorElement=r||e;const i=e.firstElementChild;if(i)e=i,n=n.firstElementChild;else{let r;for(;e!==t&&!(r=e.nextElementSibling);)e=e.parentElement,n=n.parentElement;if(e===t)break;e=r,n=n.nextElementSibling}}return n}function e(t=location.href){if(/circle=/.test(t)){const[e,n=""]=t.split("#");if(!n)return t;const{hashs:r}=function(t,e,n=location.hash.substring(1).split("&")){let r=[];if(n.join("").length<=0)return{hashs:[],hash:r};const i=Array.isArray(t)?t:[t],o=n.filter((t=>{if(i.findIndex((e=>t.indexOf(e)>=0))<0)return!0;r.push(t)}));if(e){const n=`${t}=${e}`;o.push(n),r=[],r.push(n)}return{hashs:o,hash:r}}(["circle","widget"],void 0,n.split("&"));return`${e}${r.length>0?"#"+r.join("&"):""}`}return t}function n(t,e){if(!t)return;let n=0;if(t.forEach){const r=t.length;if(r<=0)return;for(;n<r&&!e(t[n],n);)n++}else{const r=Object.keys(t),i=r.length;if(i<=0)return;for(;n<i&&!e(t[r[n]],r[n]);)n++}}function r(t,e){return Object.prototype.toString.call(t)===`[object ${e}]`}function i(t){return r(t,"Undefined")}function o(t){return r(t,"String")}function a(t){return t&&t.nodeType&&1===t.nodeType}function c(t){return r(t,"Number")}function l(t){return r(t,"Boolean")}function s(t){return r(t,"Object")}function u(e,r,i){if(r.querySelectorAll("img").length>0){const o=t(r),c=e.field("container");return a(c)&&c.style.cssText.indexOf("imagehide: none")>=0?n(o.querySelectorAll("img"),(t=>{let e=t;for(;e&&o.contains(e);){const t=e.parentElement;if(!t)break;if(!(t.innerText.trim().length<=0))break;t.removeChild(e),e=t}})):n(o.querySelectorAll("img"),(t=>{let e=t;t._mirrorElement&&(a(t._mirrorElement._mirrorElement)?e=t._mirrorElement._mirrorElement:a(t._mirrorElement)&&(e=t._mirrorElement));const r=[];if(n(t.attributes,(t=>{const e=t.nodeName;!["class","src"].includes(e)&&r.push(e)})),n(r,(e=>{t.removeAttribute(e)})),!i)return;const o=Math.max(e.width,t.width),c=Math.max(e.height,t.height),l=Math.min(o,410);t.width=l,t.height=c*(l/o),t.src=t.src.replace("https","http")})),o}return r}function m(t,n){const r=t.user,c={};["uid","mail","name","avatar"].forEach((t=>{c[t]=r[t]||""}));const l={};if(n)o(n)&&n.length>0?l.content=n.replace(/\n+/g,"<br />").trim():a(n)&&(l.content=n.innerHTML.trim());else{const n=function(t){const n=t.field("node");if(Array.isArray(n)&&n.length>0){const e=n[0];if(Array.isArray(e.content)){let n="";e.content.forEach((e=>{o(e.content)?n+=e.content:a(e.content)&&(n+=u(t,e.content).innerHTML.trim())}));const r=document.createElement("div");r.innerHTML=n,e.content=r}return a(e.content)&&(e.content=u(t,e.content)),e.title||(e.title=`${t.i18n("name")} - ${t.i18n("description")}`),Object.assign(Object.assign({},e),{content:a(e.content)?e.content.innerHTML.trim():e.content.trim(),title:a(e.title)?e.title.innerText.trim():e.title.trim(),tags:Array.isArray(e.tags)&&e.tags.length>0?e.tags.join(","):"",author:Array.isArray(e.author)&&e.author.length>0?e.author.map((t=>t.name)).join(","):""})}return{url:e(),title:document.title.trim(),content:document.body.innerHTML.trim()}}(t);Object.keys(n).forEach((t=>{i(n[t])||(l[t]=n[t])}))}return{node:l,app:{name:t.i18n("name"),version:`v${t.version}`,description:t.i18n("description")},user:Object.assign(Object.assign({},c),{url:t.path(`user/${c.uid||0}`)})}}function f(e,r,l){const f=[],p=m(e,l.part);return(Array.isArray(r)?r:[r]).forEach((r=>{let m="";if(l.option&&l.option[r])m=l.option[r].replace(/\[([^[|^\]]+)\]/g,((t,e)=>{const[n,r,o,a]=e.trim().split(":");if(n&&r){const t=p[n];if(s(t)){const e=t[r];if(i(e))return"";const n=`${e}`;if(o&&a){const t=parseFloat(o),e=parseFloat(a);if(c(t)&&t>=0&&c(e)&&e>0&&e>t){const r=n.slice(t,e);return e<n.length?`${r}...`:r}return n}return n}return""}return""}));else if(["template","part_template"].includes(r))if(l.part)o(l.part)&&l.part.length>0?m=function(t){if(!o(t))return!1;const e=document.createElement("div");e.innerHTML=t;let r=!1;return n(e.childNodes,(t=>{if(1===t.nodeType)return r=!0,!0})),r}(l.part)?l.part.replace(/\n+/g,"<br />").trim():l.part.trim():a(l.part)&&(m=l.part.innerHTML.trim());else{const n=e.field("container");if(a(n)){const r=n.querySelector(".page");if(a(r)){const n=t(r);(l.removeMeta?["footer","title","meta","cover","excerpt","noise"]:["noise"]).forEach((t=>{const e=n.querySelector(`.${t}`);e&&e.parentElement&&e.parentElement.removeChild(e)})),m=u(e,n,l.resizeImage).innerHTML.trim()}else m=p.node.content}else m=p.node.content}else{const t=r.split("_").shift()||"";m=p.node[t]||"--"}f.push(e.applyFilter(r,m,l))})),1===f.length?f[0]:f}function p(t,e,n=""){return n?f(t,["title_part_template","part_template"],{...e,part:n}):f(t,["title_template","template"],e)}function h(t,e,n){if(n)return Promise.resolve(e);const r=[...e.querySelectorAll("img")];return r.length<=0?Promise.resolve(e):function(t,e){return t.fetch(e,{format:"blob",silence:!0}).then((t=>Promise.resolve(t.map((t=>t.data?{src:t.url,url:t.data}:{src:t.url,url:t.url})))))}(t,r.map((t=>t.src))).then((t=>(t.forEach((t=>{if(!s(t))return;const{src:e,url:n}=t,i=r.find((t=>t.src===e));i&&(i.src=n,["action","srcset","sizes"].forEach((t=>{i.removeAttribute(t)})))})),Promise.resolve(e))))}window.definePlugin("export_marked",(function(t,e){const n=(n,r)=>{const i=r.selector||t.id,o=r.exportFromDOMOrString||"",[a,c]=p(e,{option:n,id:t.id},o);e.fire("toolbar_state",i,"loading");const l=document.createElement("div");l.innerHTML=c,h(e,l,!(n&&n.inline)).then((t=>{e.fire("marked",t.innerHTML,{annotator:!!n.annotator,annotator_idea:!!n.annotator_idea},(t=>{e.fire("saver",t,`${a}.md`),e.fire("toolbar_state",i,"loaded"),e.fire("remove_slogan_alert")}))}))};return{onSelf(t,e){t.option("option").then((t=>{n(t,{exportFromDOMOrString:e})}))},onExportMarked_Inline(t){t.option("option").then((t=>{n({...t||{},inline:!0},{selector:"export_marked__inline"})}))},data:(n,r)=>e.option("option").then((i=>{const[o,a]=p(e,{option:i,id:t.id,removeMeta:!0},n);return new Promise((t=>{e.fire("marked",a,{annotator:!(!r||!l(r.annotator))&&r.annotator,annotator_idea:!(!r||!l(r.annotator_idea))&&r.annotator_idea},(e=>{t({title:o,content:e})}))}))}))}}))})();